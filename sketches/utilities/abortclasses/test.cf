body common control
{
      bundlesequence => { "cfsketch_run", "cfsketch_after" };
      inputs => { "./main.cf", "../../libraries/copbl/cfengine_stdlib.cf", };
}

body agent control
{
      abortclasses => { "cowboy" };
}

bundle common cfsketch_g
{
  vars:
    !test::
      "abort_trigger_file" string => "/COWBOY";
    test::
      "abort_trigger_file" string => "/tmp/COWBOY";

    any::
      "abort_abortclass"      string => "cowboy";
      "abort_alert_only"      string => "0";
      "abort_trigger_context" string => "!opt_dry_run";
      "autoclear[enabled]"    string => "1";
      "autoclear[timestamp]"  string => "mtime";
      "autoclear[years]"      string => "0";
      "autoclear[months]"     string => "0";
      "autoclear[days]"       string => "0";
      "autoclear[hours]"      string => "0";
      "autoclear[minutes]"    string => "2";
      "autoclear[seconds]"    string => "0";

}

bundle agent cfsketch_run
{
  methods:
      "go" usebundle => abortclasses_filebased($(cfsketch_g.abort_abortclass),
                                               $(cfsketch_g.abort_trigger_file),
                                               $(cfsketch_g.abort_alert_only),
                                               $(cfsketch_g.abort_trigger_context),
                                               "cfsketch_g.autoclear");

}
bundle agent cfsketch_after
{
  reports:
    opt_dry_run::
      "I didnt abort because I was in dry run";
}
